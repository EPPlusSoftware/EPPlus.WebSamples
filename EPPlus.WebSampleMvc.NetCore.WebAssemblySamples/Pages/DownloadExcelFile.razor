@page "/downloadexcelfile"
@using System.IO
@using OfficeOpenXml
@using Microsoft.JSInterop
@using System.Net
@using System.Reflection
@using System.Dynamic
@using System.Text.Json
@using OfficeOpenXml.Table
@inject IJSRuntime JS

<div class="row">
    <div class="col">
        <h5>Download file from EPPlus</h5>
        <p>This sample generates a simple workbook with EPPlus running in a client side Blazor environment - in other words, this workbook is generated by EPPlus 6 running in your browser.</p>
        <p>Features included: </p>
        <ul>
            <li>Autofit columns and adding images in client side Blazor with no access to System.Drawing (needed by previous versions).</li>
            <li>Calculating the formulas in the workbook</li>
            <li>Importing json data delivered by a JavaScript function on the page via the <i>LoadFromDictionaries</i> method</li>
        </ul>
    </div>
</div>



<button class="btn btn-primary" @onclick="DownloadExcel">Download workbook</button>

@code {
    private int currentCount = 0;

    async Task DownloadExcel()
    {
        // read png image from embedded resource
        var imageBytes = default(byte[]);
        using var stream = Assembly.GetExecutingAssembly().GetManifestResourceStream("EPPlus.WebSampleMvc.NetCore.WebAssemblySamples.Resources.EPPlus-logo-full.png");
        using var sr = new BinaryReader(stream);
        imageBytes = sr.ReadBytes((int)stream.Length);

        // get some json data from a javascript function and convert it into ExpandoObjects (dynamic objects)
        var json = await JS.InvokeAsync<string>("getCities");
        IEnumerable<ExpandoObject> cities = JsonSerializer.Deserialize<IEnumerable<ExpandoObject>>(json);

        using(var package = new ExcelPackage())
        {
            var sheet = package.Workbook.Worksheets.Add("Test");

            // load the dynamic objects into EPPlus using the LoadFromDictionaries method.
            var loadedRange = sheet.Cells["A5"].LoadFromDictionaries(cities, x => {
                x.TableStyle = OfficeOpenXml.Table.TableStyles.Medium13;
                x.PrintHeaders = true;
                x.DataTypes = new eDataTypes[] { eDataTypes.String, eDataTypes.Number, eDataTypes.String, eDataTypes.Number };
            });
            var table = sheet.Tables.GetFromRange(loadedRange);
            table.ShowTotal = true;
            table.Columns[0].TotalsRowLabel = "Average";
            table.Columns[1].TotalsRowFunction = RowFunctions.Average;
            table.Columns[3].TotalsRowFunction = RowFunctions.Average;
            sheet.Cells[table.Range.Start.Row, 2, table.Range.End.Row, 2].Style.Numberformat.Format = "#,##0";
            sheet.Cells[table.Range.Start.Row, 4, table.Range.End.Row, 4].Style.Numberformat.Format = "#,##0 \"km2\"";
            // Calculate the formulas in the worksheet, in this case the average functions of the table's total row
            sheet.Calculate();
            // Adjust the column width after the widest text in the cells
            sheet.Cells[1, 1, sheet.Dimension.End.Row, sheet.Dimension.End.Column].AutoFitColumns();
            if(imageBytes != null)
            {
                using(var ms = new MemoryStream(imageBytes))
                {
                    var pic = sheet.Drawings.AddPicture("epplogo", ms, OfficeOpenXml.Drawing.ePictureType.Png);
                    pic.SetSize(50);
                    pic.SetPosition(0, 10, 0, 10);
                }
            }
            await JS.InvokeVoidAsync("BlazorDownloadFile", "Excel.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", package.GetAsByteArray());

        }
    }
}
